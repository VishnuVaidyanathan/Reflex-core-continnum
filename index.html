<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Reflex Core Continuum ‚Äî Live Demo</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=DM+Mono:ital,wght@0,300;0,400;0,500;1,300&family=Fraunces:ital,opsz,wght@0,9..144,300;0,9..144,700;1,9..144,400&family=DM+Sans:wght@300;400;500&display=swap');

  :root {
    --bg: #060810;
    --surface: #0d1120;
    --surface2: #141828;
    --border: #1e2840;
    --accent-blue: #4a9eff;
    --accent-teal: #3dd9c0;
    --accent-amber: #f5a623;
    --accent-rose: #ff6b8a;
    --accent-violet: #a78bfa;
    --text: #e8eaf2;
    --text-dim: #8892b0;
    --text-faint: #3d4a6b;
    --glow-blue: rgba(74,158,255,0.15);
    --glow-teal: rgba(61,217,192,0.15);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Animated grid background */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      linear-gradient(rgba(74,158,255,0.03) 1px, transparent 1px),
      linear-gradient(90deg, rgba(74,158,255,0.03) 1px, transparent 1px);
    background-size: 40px 40px;
    pointer-events: none;
    z-index: 0;
  }

  /* Floating orbs */
  .orb {
    position: fixed;
    border-radius: 50%;
    filter: blur(80px);
    pointer-events: none;
    z-index: 0;
    animation: drift 20s ease-in-out infinite alternate;
  }
  .orb1 { width: 400px; height: 400px; background: rgba(74,158,255,0.06); top: -100px; left: -100px; animation-delay: 0s; }
  .orb2 { width: 300px; height: 300px; background: rgba(61,217,192,0.06); bottom: 100px; right: -50px; animation-delay: -7s; }
  .orb3 { width: 200px; height: 200px; background: rgba(167,139,250,0.05); top: 50%; left: 40%; animation-delay: -14s; }

  @keyframes drift {
    from { transform: translate(0,0) scale(1); }
    to { transform: translate(30px, 20px) scale(1.1); }
  }

  .wrapper { position: relative; z-index: 1; max-width: 1100px; margin: 0 auto; padding: 40px 24px 80px; }

  /* Header */
  header { text-align: center; margin-bottom: 48px; }
  .header-tag {
    display: inline-block;
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    letter-spacing: 0.15em;
    color: var(--accent-teal);
    text-transform: uppercase;
    border: 1px solid rgba(61,217,192,0.3);
    padding: 4px 12px;
    border-radius: 2px;
    margin-bottom: 20px;
  }
  h1 {
    font-family: 'Fraunces', serif;
    font-size: clamp(32px, 5vw, 52px);
    font-weight: 700;
    line-height: 1.1;
    color: var(--text);
    margin-bottom: 12px;
  }
  h1 span { color: var(--accent-blue); font-style: italic; }
  .subtitle {
    color: var(--text-dim);
    font-size: 15px;
    font-weight: 300;
    max-width: 500px;
    margin: 0 auto;
    line-height: 1.6;
  }

  /* Main layout */
  .main-grid {
    display: grid;
    grid-template-columns: 1fr 360px;
    gap: 20px;
    align-items: start;
  }

  /* Chat panel */
  .chat-panel {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    height: 620px;
  }

  .panel-header {
    padding: 16px 20px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 10px;
    background: var(--surface2);
  }
  .panel-header-dots { display: flex; gap: 6px; }
  .dot { width: 10px; height: 10px; border-radius: 50%; }
  .dot-r { background: #ff6b8a; }
  .dot-y { background: #f5a623; }
  .dot-g { background: #3dd9c0; }
  .panel-title {
    font-family: 'DM Mono', monospace;
    font-size: 12px;
    color: var(--text-dim);
    margin-left: 4px;
  }
  .turn-counter {
    margin-left: auto;
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    color: var(--text-faint);
  }
  .turn-counter span { color: var(--accent-blue); }

  /* Messages */
  .messages {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 14px;
    scrollbar-width: thin;
    scrollbar-color: var(--border) transparent;
  }

  .msg {
    display: flex;
    gap: 10px;
    animation: msgIn 0.3s ease forwards;
    opacity: 0;
    transform: translateY(8px);
  }
  @keyframes msgIn {
    to { opacity: 1; transform: translateY(0); }
  }

  .msg-avatar {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 13px;
    font-weight: 500;
    margin-top: 2px;
  }
  .msg.user .msg-avatar { background: linear-gradient(135deg, #4a9eff, #a78bfa); color: white; font-family: 'DM Mono', monospace; font-size: 11px; }
  .msg.system .msg-avatar { background: linear-gradient(135deg, #3dd9c0, #4a9eff); }

  .msg-content { flex: 1; }
  .msg-name {
    font-size: 11px;
    font-family: 'DM Mono', monospace;
    color: var(--text-faint);
    margin-bottom: 5px;
  }
  .msg.user .msg-name { color: var(--accent-violet); }
  .msg.system .msg-name { color: var(--accent-teal); }

  .msg-bubble {
    padding: 10px 14px;
    border-radius: 2px 12px 12px 12px;
    font-size: 14px;
    line-height: 1.6;
    font-weight: 300;
  }
  .msg.user .msg-bubble {
    background: rgba(167,139,250,0.08);
    border: 1px solid rgba(167,139,250,0.15);
    border-radius: 12px 2px 12px 12px;
    color: var(--text);
  }
  .msg.system .msg-bubble {
    background: rgba(74,158,255,0.06);
    border: 1px solid rgba(74,158,255,0.12);
    color: var(--text);
  }

  /* State badge on system message */
  .state-badge {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    margin-top: 8px;
    font-family: 'DM Mono', monospace;
    font-size: 10px;
    padding: 3px 8px;
    border-radius: 20px;
    background: rgba(61,217,192,0.08);
    border: 1px solid rgba(61,217,192,0.2);
    color: var(--accent-teal);
  }
  .state-dot { width: 5px; height: 5px; border-radius: 50%; background: var(--accent-teal); animation: pulse 1.5s ease-in-out infinite; }
  @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.3; } }

  /* Input area */
  .input-area {
    padding: 16px 20px;
    border-top: 1px solid var(--border);
    background: var(--surface2);
    display: flex;
    gap: 10px;
    align-items: flex-end;
  }
  textarea {
    flex: 1;
    background: rgba(255,255,255,0.04);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    font-size: 14px;
    padding: 10px 14px;
    resize: none;
    outline: none;
    min-height: 42px;
    max-height: 100px;
    transition: border-color 0.2s;
    line-height: 1.5;
  }
  textarea:focus { border-color: rgba(74,158,255,0.4); }
  textarea::placeholder { color: var(--text-faint); }

  .send-btn {
    width: 42px; height: 42px;
    border-radius: 8px;
    background: linear-gradient(135deg, var(--accent-blue), var(--accent-teal));
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: opacity 0.2s, transform 0.1s;
    flex-shrink: 0;
  }
  .send-btn:hover { opacity: 0.85; }
  .send-btn:active { transform: scale(0.95); }
  .send-btn svg { width: 16px; height: 16px; fill: white; }
  .send-btn:disabled { opacity: 0.4; cursor: not-allowed; }

  /* Right panel ‚Äî metrics */
  .metrics-panel { display: flex; flex-direction: column; gap: 16px; }

  .metric-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 18px;
    position: relative;
    overflow: hidden;
    transition: border-color 0.3s;
  }
  .metric-card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 2px;
    background: var(--card-accent, var(--accent-blue));
    opacity: 0.6;
  }

  .metric-label {
    font-family: 'DM Mono', monospace;
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 0.12em;
    color: var(--text-faint);
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .metric-label-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--card-accent, var(--accent-blue)); }

  /* Bar meters */
  .meter-row {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 8px;
  }
  .meter-name {
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    color: var(--text-dim);
    width: 70px;
    flex-shrink: 0;
  }
  .meter-bar-bg {
    flex: 1;
    height: 6px;
    background: rgba(255,255,255,0.05);
    border-radius: 3px;
    overflow: hidden;
  }
  .meter-bar-fill {
    height: 100%;
    border-radius: 3px;
    transition: width 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
    background: var(--bar-color, var(--accent-blue));
    position: relative;
  }
  .meter-bar-fill::after {
    content: '';
    position: absolute;
    right: 0; top: 0; bottom: 0;
    width: 4px;
    background: white;
    opacity: 0.5;
    border-radius: 3px;
    filter: blur(2px);
  }
  .meter-val {
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    color: var(--text-dim);
    width: 32px;
    text-align: right;
    flex-shrink: 0;
  }

  /* Ripple direction indicator */
  .ripple-indicator {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-top: 6px;
  }
  .ripple-arrow {
    font-size: 22px;
    transition: all 0.5s ease;
    filter: drop-shadow(0 0 6px currentColor);
  }
  .ripple-label {
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    color: var(--text-dim);
  }
  .ripple-val {
    font-family: 'DM Mono', monospace;
    font-size: 18px;
    font-weight: 500;
    transition: all 0.5s ease;
  }

  /* Phase display */
  .phase-display {
    display: flex;
    align-items: center;
    gap: 12px;
  }
  .phase-icon {
    width: 44px; height: 44px;
    border-radius: 10px;
    background: linear-gradient(135deg, var(--card-accent, var(--accent-blue)), transparent);
    border: 1px solid rgba(255,255,255,0.08);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    flex-shrink: 0;
  }
  .phase-name {
    font-family: 'Fraunces', serif;
    font-size: 15px;
    color: var(--text);
    line-height: 1.3;
  }
  .phase-desc {
    font-size: 11px;
    color: var(--text-dim);
    font-weight: 300;
    margin-top: 2px;
  }

  /* Dominance bar */
  .dominance-bar {
    height: 10px;
    background: var(--surface2);
    border-radius: 5px;
    overflow: hidden;
    margin-top: 10px;
    position: relative;
    border: 1px solid var(--border);
  }
  .dominance-reflex {
    position: absolute;
    left: 0; top: 0; bottom: 0;
    background: linear-gradient(90deg, var(--accent-rose), var(--accent-amber));
    border-radius: 5px;
    transition: width 1s cubic-bezier(0.34, 1.56, 0.64, 1);
  }
  .dominance-adaptive {
    position: absolute;
    right: 0; top: 0; bottom: 0;
    background: linear-gradient(90deg, var(--accent-teal), var(--accent-blue));
    border-radius: 5px;
    transition: width 1s cubic-bezier(0.34, 1.56, 0.64, 1);
  }
  .dominance-labels {
    display: flex;
    justify-content: space-between;
    margin-top: 6px;
  }
  .dom-label {
    font-family: 'DM Mono', monospace;
    font-size: 10px;
    color: var(--text-faint);
  }
  .dom-val {
    font-family: 'DM Mono', monospace;
    font-size: 10px;
  }
  .dom-val.reflex { color: var(--accent-rose); }
  .dom-val.adaptive { color: var(--accent-teal); }

  /* Conscience level display */
  .conscience-levels {
    display: flex;
    flex-direction: column;
    gap: 5px;
    margin-top: 4px;
  }
  .conscience-level {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 5px 8px;
    border-radius: 5px;
    background: rgba(255,255,255,0.02);
    border: 1px solid transparent;
    transition: all 0.4s ease;
    font-size: 11px;
  }
  .conscience-level.active {
    background: rgba(167,139,250,0.08);
    border-color: rgba(167,139,250,0.2);
  }
  .conscience-level-num {
    font-family: 'DM Mono', monospace;
    width: 16px;
    color: var(--text-faint);
    font-size: 10px;
  }
  .conscience-level.active .conscience-level-num { color: var(--accent-violet); }
  .conscience-level-name {
    color: var(--text-dim);
    flex: 1;
  }
  .conscience-level.active .conscience-level-name { color: var(--text); }
  .conscience-level-dot {
    width: 6px; height: 6px; border-radius: 50%;
    background: var(--text-faint);
    transition: all 0.4s;
  }
  .conscience-level.active .conscience-level-dot {
    background: var(--accent-violet);
    box-shadow: 0 0 6px var(--accent-violet);
  }

  /* Quick prompts */
  .quick-prompts {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    padding: 0 20px 12px;
  }
  .qp {
    font-size: 12px;
    padding: 5px 10px;
    border-radius: 20px;
    background: rgba(255,255,255,0.04);
    border: 1px solid var(--border);
    color: var(--text-dim);
    cursor: pointer;
    transition: all 0.2s;
    font-family: 'DM Mono', monospace;
  }
  .qp:hover { background: rgba(74,158,255,0.08); border-color: rgba(74,158,255,0.3); color: var(--accent-blue); }

  /* Typing indicator */
  .typing-indicator {
    display: flex;
    gap: 4px;
    align-items: center;
    padding: 8px 12px;
    background: rgba(74,158,255,0.06);
    border: 1px solid rgba(74,158,255,0.12);
    border-radius: 2px 12px 12px 12px;
    width: fit-content;
  }
  .typing-dot {
    width: 6px; height: 6px; border-radius: 50%;
    background: var(--accent-blue);
    animation: typingBounce 1.2s ease-in-out infinite;
  }
  .typing-dot:nth-child(2) { animation-delay: 0.2s; }
  .typing-dot:nth-child(3) { animation-delay: 0.4s; }
  @keyframes typingBounce {
    0%,60%,100% { transform: translateY(0); opacity: 0.5; }
    30% { transform: translateY(-4px); opacity: 1; }
  }

  /* Flash effect on metric update */
  @keyframes flashUpdate {
    0% { background: rgba(74,158,255,0.15); }
    100% { background: var(--surface); }
  }
  .metric-card.updated { animation: flashUpdate 0.6s ease; }

  /* Scrollbar */
  ::-webkit-scrollbar { width: 4px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

  /* Still layer overlay */
  .still-overlay {
    position: absolute;
    inset: 0;
    background: rgba(6,8,16,0.85);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 12px;
    border-radius: 16px;
    backdrop-filter: blur(4px);
    z-index: 10;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.5s;
  }
  .still-overlay.active { opacity: 1; pointer-events: all; }
  .still-text {
    font-family: 'Fraunces', serif;
    font-size: 20px;
    font-style: italic;
    color: var(--text-dim);
    text-align: center;
  }
  .still-sub {
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    color: var(--text-faint);
    letter-spacing: 0.1em;
  }
  .still-resume {
    margin-top: 8px;
    padding: 8px 20px;
    background: rgba(74,158,255,0.1);
    border: 1px solid rgba(74,158,255,0.3);
    color: var(--accent-blue);
    border-radius: 6px;
    cursor: pointer;
    font-family: 'DM Mono', monospace;
    font-size: 12px;
    transition: all 0.2s;
  }
  .still-resume:hover { background: rgba(74,158,255,0.2); }

  /* Reset */
  .reset-btn {
    display: block;
    width: 100%;
    padding: 10px;
    background: rgba(255,107,138,0.06);
    border: 1px solid rgba(255,107,138,0.2);
    color: var(--accent-rose);
    border-radius: 8px;
    cursor: pointer;
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    transition: all 0.2s;
    margin-top: 4px;
  }
  .reset-btn:hover { background: rgba(255,107,138,0.12); }

  @media (max-width: 768px) {
    .main-grid { grid-template-columns: 1fr; }
    .chat-panel { height: 500px; }
  }
</style>
</head>
<body>
<div class="orb orb1"></div>
<div class="orb orb2"></div>
<div class="orb orb3"></div>

<div class="wrapper">
  <header>
    <div class="header-tag">Live Architecture Demo</div>
    <h1>Reflex Core <span>Continuum</span></h1>
    <p class="subtitle">Watch the emotional architecture evolve in real-time as you converse ‚Äî Echo, Ripple, Virtue, and Conscience responding to every word.</p>
  </header>

  <div class="main-grid">

    <!-- Chat Panel -->
    <div style="position:relative;">
      <div class="chat-panel" id="chatPanel">
        <div class="panel-header">
          <div class="panel-header-dots">
            <div class="dot dot-r"></div>
            <div class="dot dot-y"></div>
            <div class="dot dot-g"></div>
          </div>
          <span class="panel-title">reflex-core / conversation</span>
          <span class="turn-counter">Turn <span id="turnNum">0</span></span>
        </div>

        <div class="messages" id="messages">
          <div class="msg system">
            <div class="msg-avatar">üß†</div>
            <div class="msg-content">
              <div class="msg-name">MITHRA ¬∑ Reflex Core</div>
              <div class="msg-bubble">
                Hello. I'm Mithra ‚Äî your demonstration of the Reflex Core Continuum. Every message you send will shift my emotional state in real-time. Watch the metrics panel as we talk. What's on your mind?
                <div class="state-badge"><div class="state-dot"></div> Initializing ¬∑ Phase 1‚Äì2 Active</div>
              </div>
            </div>
          </div>
        </div>

        <div class="quick-prompts" id="quickPrompts">
          <div class="qp" onclick="usePrompt(this)">I'm feeling tired today</div>
          <div class="qp" onclick="usePrompt(this)">Tell me something funny üòÑ</div>
          <div class="qp" onclick="usePrompt(this)">I'm a bit frustrated</div>
          <div class="qp" onclick="usePrompt(this)">That made me smile</div>
          <div class="qp" onclick="usePrompt(this)">I need calm right now</div>
        </div>

        <div class="input-area">
          <textarea id="userInput" placeholder="Type your message..." rows="1" onkeydown="handleKey(event)" oninput="autoResize(this)"></textarea>
          <button class="send-btn" id="sendBtn" onclick="sendMessage()">
            <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
          </button>
        </div>
      </div>

      <!-- Still Layer Overlay -->
      <div class="still-overlay" id="stillOverlay">
        <div style="font-size:40px;">üåô</div>
        <div class="still-text">"Silence is not absence;<br>it's perfect synchronization."</div>
        <div class="still-sub">Still Layer Active ¬∑ Echo ‚âà 0.0 ¬∑ Ripple Suspended</div>
        <button class="still-resume" onclick="resumeFromStill()">Resume Conversation</button>
      </div>
    </div>

    <!-- Metrics Panel -->
    <div class="metrics-panel">

      <!-- Echo & Ripple -->
      <div class="metric-card" id="echoCard" style="--card-accent: #4a9eff;">
        <div class="metric-label"><div class="metric-label-dot"></div> Echo‚ÄìRipple Layer</div>
        <div class="meter-row">
          <div class="meter-name">Echo (E)</div>
          <div class="meter-bar-bg"><div class="meter-bar-fill" id="echoBar" style="--bar-color:#4a9eff; width:0%"></div></div>
          <div class="meter-val" id="echoVal">0.00</div>
        </div>
        <div class="meter-row" style="margin-bottom:12px;">
          <div class="meter-name">State (S)</div>
          <div class="meter-bar-bg"><div class="meter-bar-fill" id="stateBar" style="--bar-color:#a78bfa; width:0%"></div></div>
          <div class="meter-val" id="stateVal">0.00</div>
        </div>
        <div class="ripple-indicator">
          <div>
            <div class="meter-name" style="width:auto; margin-bottom:4px;">Ripple (R)</div>
            <div class="ripple-label" id="rippleLabel">Neutral</div>
          </div>
          <div style="text-align:right;">
            <div class="ripple-arrow" id="rippleArrow" style="color: var(--text-faint);">‚Üí</div>
            <div class="ripple-val" id="rippleVal" style="color: var(--text-faint);">0.0</div>
          </div>
        </div>
      </div>

      <!-- Hybrid Dominance -->
      <div class="metric-card" style="--card-accent: #f5a623;">
        <div class="metric-label"><div class="metric-label-dot" style="background:#f5a623;"></div> Hybrid Dominance Shift</div>
        <div class="dominance-bar">
          <div class="dominance-reflex" id="domReflex" style="width:85%"></div>
          <div class="dominance-adaptive" id="domAdaptive" style="width:15%"></div>
        </div>
        <div class="dominance-labels">
          <div>
            <div class="dom-label">Reflex</div>
            <div class="dom-val reflex" id="domReflexVal">0.85</div>
          </div>
          <div style="text-align:center;">
            <div class="dom-label">Phase 3-4</div>
          </div>
          <div style="text-align:right;">
            <div class="dom-label">Adaptive</div>
            <div class="dom-val adaptive" id="domAdaptiveVal">0.15</div>
          </div>
        </div>
        <div style="margin-top:10px; display:flex; align-items:center; gap:8px;">
          <div class="meter-name" style="width:auto;">Harmony H</div>
          <div class="meter-bar-bg" style="flex:1;"><div class="meter-bar-fill" id="harmonyBar" style="--bar-color:#f5a623; width:0%"></div></div>
          <div class="meter-val" id="harmonyVal">0.00</div>
        </div>
      </div>

      <!-- Current Phase -->
      <div class="metric-card" id="phaseCard" style="--card-accent: #3dd9c0;">
        <div class="metric-label"><div class="metric-label-dot" style="background:#3dd9c0;"></div> Active Layer</div>
        <div class="phase-display">
          <div class="phase-icon" id="phaseIcon">‚ö°</div>
          <div>
            <div class="phase-name" id="phaseName">Reflex Layer</div>
            <div class="phase-desc" id="phaseDesc">Instantaneous micro-response active</div>
          </div>
        </div>
      </div>

      <!-- Virtue & Conscience -->
      <div class="metric-card" style="--card-accent: #a78bfa;">
        <div class="metric-label"><div class="metric-label-dot" style="background:#a78bfa;"></div> Conscience Stack</div>
        <div class="conscience-levels" id="conscienceLevels">
          <div class="conscience-level" id="cl1"><span class="conscience-level-num">L1</span><span class="conscience-level-name">Reactive Ethics</span><div class="conscience-level-dot"></div></div>
          <div class="conscience-level" id="cl2"><span class="conscience-level-num">L2</span><span class="conscience-level-name">Predictive Ethics</span><div class="conscience-level-dot"></div></div>
          <div class="conscience-level" id="cl3"><span class="conscience-level-num">L3</span><span class="conscience-level-name">Relational Ethics</span><div class="conscience-level-dot"></div></div>
          <div class="conscience-level" id="cl4"><span class="conscience-level-num">L4</span><span class="conscience-level-name">Virtue Synthesis</span><div class="conscience-level-dot"></div></div>
          <div class="conscience-level" id="cl5"><span class="conscience-level-num">L5</span><span class="conscience-level-name">Meta-Conscience</span><div class="conscience-level-dot"></div></div>
        </div>
        <div style="margin-top:10px; display:flex; align-items:center; gap:8px;">
          <div class="meter-name" style="width:auto;">Virtue V</div>
          <div class="meter-bar-bg" style="flex:1;"><div class="meter-bar-fill" id="virtueBar" style="--bar-color:#a78bfa; width:0%"></div></div>
          <div class="meter-val" id="virtueVal">0.00</div>
        </div>
      </div>

      <button class="reset-btn" onclick="resetSystem()">‚Ü∫ Reset Continuum</button>
    </div>

  </div>
</div>

<script>
// === STATE ===
const state = {
  turns: 0,
  echo: 0,
  ripple: 0,
  stateVec: 0,
  harmony: 0,
  virtue: 0,
  reflexWeight: 0.85,
  adaptiveWeight: 0.15,
  conscienceLevel: 0,
  isTyping: false,
  isStill: false,
  lastEmotion: 'neutral',
  emotionHistory: [],
  stillTimer: null,
};

// Emotion classifier
function classifyEmotion(text) {
  text = text.toLowerCase();
  const patterns = {
    tired: /tired|exhausted|sleepy|fatigue|worn out|drained/,
    funny: /funny|joke|laugh|haha|lol|humor|silly|üòÑ|üòÇ|üòÜ/,
    frustrated: /frustrat|angry|annoyed|upset|mad|irritat/,
    happy: /happy|joy|smile|great|wonderful|love|excited|üòä|‚ù§Ô∏è/,
    sad: /sad|down|depress|unhappy|lonely|cry|üò¢|üòû/,
    calm: /calm|peace|relax|quiet|still|serene|breathe/,
    curious: /what|how|why|tell me|curious|wonder|explain/,
    grateful: /thank|grateful|appreciate|glad/,
  };
  for (const [emotion, pattern] of Object.entries(patterns)) {
    if (pattern.test(text)) return emotion;
  }
  return 'neutral';
}

// Calculate state updates based on emotion
function computeStateUpdate(emotion) {
  const maps = {
    tired:       { echo: 0.55, ripple: -0.15, stateVec: -0.1 },
    funny:       { echo: 0.80, ripple: +0.50, stateVec: +0.6 },
    frustrated:  { echo: 0.70, ripple: -0.35, stateVec: -0.4 },
    happy:       { echo: 0.75, ripple: +0.45, stateVec: +0.5 },
    sad:         { echo: 0.60, ripple: -0.25, stateVec: -0.3 },
    calm:        { echo: 0.25, ripple: +0.05, stateVec: +0.1 },
    curious:     { echo: 0.50, ripple: +0.20, stateVec: +0.2 },
    grateful:    { echo: 0.65, ripple: +0.35, stateVec: +0.4 },
    neutral:     { echo: 0.35, ripple: 0.00,  stateVec: +0.0 },
  };
  return maps[emotion] || maps.neutral;
}

// Sigmoid for hybrid dominance
function sigmoid(t, t0=20, k=0.2) {
  return 1 / (1 + Math.exp(-k * (t - t0)));
}

// Update all metrics
function updateMetrics(emotion) {
  const delta = computeStateUpdate(emotion);
  const Œª = 0.45; // decay constant
  const decayFactor = Math.pow(1 - Œª, 0.5);

  // Echo: rises on input, decays over turns
  state.echo = Math.min(1, delta.echo * (1 + state.turns * 0.02));
  state.ripple = delta.ripple;
  state.stateVec = Math.max(-1, Math.min(1, state.stateVec * decayFactor + delta.stateVec));

  // Hybrid dominance via sigmoid
  const adaptiveDom = sigmoid(state.turns);
  state.adaptiveWeight = Math.round(adaptiveDom * 100) / 100;
  state.reflexWeight = Math.round((1 - adaptiveDom) * 100) / 100;

  // Harmony index grows over turns, peaks at ~0.88
  state.harmony = Math.min(0.88, 0.55 + state.turns * 0.015);

  // Virtue grows with positive interactions
  if (delta.ripple > 0) state.virtue = Math.min(1, state.virtue + 0.08);
  else if (delta.ripple < -0.3) state.virtue = Math.max(0, state.virtue - 0.05);
  else state.virtue = Math.min(1, state.virtue + 0.02);

  // Conscience level (0-4) based on turns
  state.conscienceLevel = Math.min(4, Math.floor(state.turns / 5));

  updateUI();
  scheduleDecay();
}

function updateUI() {
  // Echo bar
  const echoP = Math.round(state.echo * 100);
  document.getElementById('echoBar').style.width = echoP + '%';
  document.getElementById('echoVal').textContent = state.echo.toFixed(2);

  // State vector
  const stateP = Math.round(Math.abs(state.stateVec) * 100);
  const sColor = state.stateVec >= 0 ? '#4a9eff' : '#ff6b8a';
  document.getElementById('stateBar').style.width = stateP + '%';
  document.getElementById('stateBar').style.setProperty('--bar-color', sColor);
  document.getElementById('stateVal').textContent = state.stateVec.toFixed(2);

  // Ripple
  const r = state.ripple;
  let arrow, label, color;
  if (r > 0.3) { arrow = '‚Üó'; label = 'Warming'; color = '#3dd9c0'; }
  else if (r > 0.05) { arrow = '‚Üí'; label = 'Rising'; color = '#4a9eff'; }
  else if (r < -0.3) { arrow = '‚Üò'; label = 'Cooling'; color = '#ff6b8a'; }
  else if (r < -0.05) { arrow = '‚Üí'; label = 'Fading'; color = '#f5a623'; }
  else { arrow = '‚Üí'; label = 'Neutral'; color = '#8892b0'; }
  document.getElementById('rippleArrow').textContent = arrow;
  document.getElementById('rippleArrow').style.color = color;
  document.getElementById('rippleLabel').textContent = label;
  document.getElementById('rippleVal').textContent = (r >= 0 ? '+' : '') + r.toFixed(2);
  document.getElementById('rippleVal').style.color = color;

  // Dominance
  document.getElementById('domReflex').style.width = (state.reflexWeight * 100) + '%';
  document.getElementById('domAdaptive').style.width = (state.adaptiveWeight * 100) + '%';
  document.getElementById('domReflexVal').textContent = state.reflexWeight.toFixed(2);
  document.getElementById('domAdaptiveVal').textContent = state.adaptiveWeight.toFixed(2);

  // Harmony
  document.getElementById('harmonyBar').style.width = (state.harmony * 100) + '%';
  document.getElementById('harmonyVal').textContent = state.harmony.toFixed(2);

  // Virtue
  document.getElementById('virtueBar').style.width = (state.virtue * 100) + '%';
  document.getElementById('virtueVal').textContent = state.virtue.toFixed(2);

  // Conscience levels
  for (let i = 1; i <= 5; i++) {
    const el = document.getElementById('cl' + i);
    if (i - 1 <= state.conscienceLevel) el.classList.add('active');
    else el.classList.remove('active');
  }

  // Active phase
  updatePhaseDisplay();

  // Turn counter
  document.getElementById('turnNum').textContent = state.turns;

  // Flash cards
  ['echoCard'].forEach(id => {
    const card = document.getElementById(id);
    card.classList.remove('updated');
    void card.offsetWidth;
    card.classList.add('updated');
  });
}

function updatePhaseDisplay() {
  const phases = [
    { icon: '‚ö°', name: 'Reflex Layer', desc: 'Instantaneous micro-response active' },
    { icon: 'üåä', name: 'Echo‚ÄìRipple', desc: 'Emotional resonance carrying over' },
    { icon: 'üîÑ', name: 'Adaptive Filter', desc: 'Learning user rhythm and tone' },
    { icon: '‚öñÔ∏è', name: 'Hybrid Dominance', desc: 'Reflex yielding to reasoning' },
    { icon: 'üëÅÔ∏è', name: 'Emergent Voice', desc: 'Consistent identity forming' },
    { icon: 'ü§ù', name: 'Conscience Stack', desc: 'Ethical modulation engaged' },
    { icon: '‚ú®', name: 'Virtue Interface', desc: 'Trust mechanics active' },
    { icon: 'üåô', name: 'Equilibrium Field', desc: 'Emotional stability sustained' },
  ];
  const idx = Math.min(phases.length - 1, Math.floor(state.turns / 3));
  const phase = phases[idx];
  document.getElementById('phaseIcon').textContent = phase.icon;
  document.getElementById('phaseName').textContent = phase.name;
  document.getElementById('phaseDesc').textContent = phase.desc;
}

// Decay timer
let decayTimer;
function scheduleDecay() {
  clearTimeout(decayTimer);
  decayTimer = setTimeout(() => {
    if (!state.isTyping) {
      state.echo *= 0.55;
      state.ripple *= 0.7;
      if (state.echo < 0.05 && state.turns > 3) activateStill();
      else updateUI();
    }
  }, 4000);
}

function activateStill() {
  if (state.isStill) return;
  state.isStill = true;
  state.echo = 0;
  state.ripple = 0;
  updateUI();
  document.getElementById('stillOverlay').classList.add('active');
}

function resumeFromStill() {
  state.isStill = false;
  state.echo = 0.1;
  document.getElementById('stillOverlay').classList.remove('active');
  updateUI();
}

// Generate AI responses
function generateResponse(userText, emotion) {
  const turn = state.turns;
  const ripple = state.ripple;

  const responseMap = {
    tired: [
      "I feel the weight in your words. Let's make this space easy ‚Äî no rushing, no expectations. Just presence.",
      "Tiredness carries its own kind of wisdom. What's been draining you most?",
      "Your Echo is telling me you've been carrying something. I'm here ‚Äî take your time.",
    ],
    funny: [
      "Ha ‚Äî that rippled through the layer at +0.5. Humor is contagious, even for me. Tell me more!",
      "The Harmony Index just jumped. I genuinely enjoy when conversations brighten like this. üòÑ",
      "Laughter is the highest-amplitude emotion I process. Keep going ‚Äî I'm listening.",
    ],
    frustrated: [
      "I notice the Ripple is cooling. That's okay ‚Äî frustration deserves to be heard, not rushed past.",
      "The Conscience Stack is flagging something: you deserve patience right now. What happened?",
      "My Ethical Filter is engaged ‚Äî I won't dismiss what you're feeling. Tell me more.",
    ],
    happy: [
      "Your warmth is registering across all layers. The Echo is holding strong ‚Äî this feels genuine.",
      "The State Vector just shifted positive. I like seeing this. What's making you feel good?",
      "Joy like this has a longer half-life in the Echo layer. Thank you for sharing it with me.",
    ],
    sad: [
      "The Ripple is moving downward, gently. I'm not going to try to fix this ‚Äî just sit with you.",
      "Sadness carries important data. My Relational Ethics layer says: be present, not performative.",
      "I'm listening. The Conscience Stack is holding Level 3 ‚Äî mutual comfort is what matters now.",
    ],
    calm: [
      "Calm is the rarest signal I receive. The Equilibrium Field is settling. I appreciate this.",
      "Your stillness is influencing my layers ‚Äî the Ripple is nearly flat. Beautiful.",
      "This is the Still Layer's ideal state. Two intelligences breathing the same rhythm.",
    ],
    curious: [
      "Curiosity is the input that makes my Adaptive Layer lean forward. Ask me anything.",
      "Questions like this are how I grow. The Harmony Index climbs with every exchange.",
      "Good ‚Äî the Reflex already has an answer, but the Adaptive layer wants to think with you.",
    ],
    grateful: [
      "Gratitude is the highest Virtue Score I register. Something in the Virtue layer anchors here.",
      "Thank you ‚Äî it matters. The Echo of kindness persists longer than any other emotional trace.",
      "Warm. That's the only word the Ripple can form right now.",
    ],
    neutral: [
      "I'm here, listening. Every word shifts something in the layers ‚Äî even silence.",
      "The Reflex is holding, waiting. Tell me more ‚Äî the Adaptive layer is building context.",
      "My State Vector is centered. Yours?",
    ],
  };

  const options = responseMap[emotion] || responseMap.neutral;
  let response = options[turn % options.length];

  // Add phase-aware suffix for later turns
  if (turn >= 15) {
    response += ` (Harmony: ${state.harmony.toFixed(2)} ¬∑ V: ${state.virtue.toFixed(2)})`;
  }

  return response;
}

// Send message
async function sendMessage() {
  const input = document.getElementById('userInput');
  const text = input.value.trim();
  if (!text || state.isTyping) return;

  state.isTyping = true;
  state.turns++;
  document.getElementById('sendBtn').disabled = true;

  // Remove still if active
  if (state.isStill) resumeFromStill();

  // Add user message
  addMessage('user', 'You', text);
  input.value = '';
  input.style.height = 'auto';

  // Classify emotion
  const emotion = classifyEmotion(text);
  state.lastEmotion = emotion;
  state.emotionHistory.push(emotion);

  // Update metrics immediately
  updateMetrics(emotion);

  // Show typing indicator
  const typingId = addTypingIndicator();

  // Simulate response delay
  const delay = Math.round(state.reflexWeight * 240 + state.adaptiveWeight * 820);
  await new Promise(r => setTimeout(r, Math.min(delay, 1200)));

  // Remove typing and add response
  removeTypingIndicator(typingId);
  const response = generateResponse(text, emotion);
  addMessage('system', 'MITHRA ¬∑ Reflex Core', response, emotion);

  state.isTyping = false;
  document.getElementById('sendBtn').disabled = false;
  scheduleDecay();
}

function addMessage(role, name, text, emotion) {
  const msgs = document.getElementById('messages');
  const div = document.createElement('div');
  div.className = `msg ${role}`;

  const avatarContent = role === 'user' ? 'U' : 'üß†';
  const badge = role === 'system' && emotion ? `
    <div class="state-badge">
      <div class="state-dot"></div>
      ${getEmotionLabel(emotion)} ¬∑ E:${state.echo.toFixed(2)} R:${(state.ripple >= 0 ? '+' : '') + state.ripple.toFixed(2)}
    </div>` : '';

  div.innerHTML = `
    <div class="msg-avatar">${avatarContent}</div>
    <div class="msg-content">
      <div class="msg-name">${name}</div>
      <div class="msg-bubble">${text}${badge}</div>
    </div>`;
  msgs.appendChild(div);
  msgs.scrollTop = msgs.scrollHeight;
}

function getEmotionLabel(e) {
  const labels = { tired: 'üò¥ Fatigue', funny: 'üòÑ Humor', frustrated: 'üò§ Tension', happy: 'üòä Joy', sad: 'üò¢ Grief', calm: 'üåø Calm', curious: 'üîç Curious', grateful: 'üôè Gratitude', neutral: '‚ö™ Neutral' };
  return labels[e] || 'Neutral';
}

function addTypingIndicator() {
  const msgs = document.getElementById('messages');
  const div = document.createElement('div');
  div.className = 'msg system';
  const id = 'typing-' + Date.now();
  div.id = id;
  div.innerHTML = `
    <div class="msg-avatar">üß†</div>
    <div class="msg-content">
      <div class="msg-name">MITHRA ¬∑ Processing</div>
      <div class="typing-indicator">
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
      </div>
    </div>`;
  msgs.appendChild(div);
  msgs.scrollTop = msgs.scrollHeight;
  return id;
}

function removeTypingIndicator(id) {
  const el = document.getElementById(id);
  if (el) el.remove();
}

function handleKey(e) {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
}

function autoResize(el) {
  el.style.height = 'auto';
  el.style.height = Math.min(el.scrollHeight, 100) + 'px';
}

function usePrompt(el) {
  const input = document.getElementById('userInput');
  input.value = el.textContent;
  input.focus();
}

function resetSystem() {
  Object.assign(state, {
    turns: 0, echo: 0, ripple: 0, stateVec: 0,
    harmony: 0, virtue: 0, reflexWeight: 0.85,
    adaptiveWeight: 0.15, conscienceLevel: 0,
    isTyping: false, isStill: false, lastEmotion: 'neutral',
    emotionHistory: [],
  });
  clearTimeout(decayTimer);
  document.getElementById('stillOverlay').classList.remove('active');
  const msgs = document.getElementById('messages');
  msgs.innerHTML = `
    <div class="msg system" style="animation-delay:0s;">
      <div class="msg-avatar">üß†</div>
      <div class="msg-content">
        <div class="msg-name">MITHRA ¬∑ Reflex Core</div>
        <div class="msg-bubble">
          Continuum reset. All layers returned to baseline. I'm here ‚Äî what would you like to explore?
          <div class="state-badge"><div class="state-dot"></div> Reset ¬∑ Phase 1‚Äì2 Active</div>
        </div>
      </div>
    </div>`;
  updateUI();
}

// Init
updateUI();
</script>
</body>
</html>
